<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Builder | 5-Model Ensemble</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { min-height: 100dvh; display: flex; flex-direction: column; overflow: hidden; background-color: #0f172a; color: #f8fafc; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        iframe { background: white; border-radius: 8px; width: 100%; height: 100%; border: none; }
        .sidebar-scroll { height: calc(100vh - 200px); overflow-y: auto; }
        .status-pill { padding: 2px 8px; border-radius: 99px; font-size: 10px; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div class="flex flex-1 overflow-hidden">
    <aside class="w-64 glass-panel flex flex-col p-4 z-20">
        <button onclick="createNew()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg mb-6 tracking-tight">+ New Project</button>
        <div class="flex-1">
            <h3 class="text-[10px] font-bold text-slate-500 uppercase mb-3">Project History</h3>
            <div id="projectList" class="sidebar-scroll space-y-2"></div>
        </div>
        <button onclick="toggleSettings(true)" class="mt-auto p-2 hover:bg-slate-800 rounded-lg flex items-center gap-2 text-slate-400 text-sm">
            ‚öôÔ∏è API Settings
        </button>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="h-14 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900">
            <div class="flex gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
            </div>
            <div id="statusText" class="text-xs text-blue-400 font-mono">System: Idle</div>
            <button onclick="downloadCode()" class="text-xs bg-slate-800 px-3 py-1 rounded border border-slate-700">Export .html</button>
        </header>

        <section class="flex-1 p-4 bg-slate-950">
            <iframe id="preview"></iframe>
        </section>

        <div id="logTray" class="px-4 py-2 bg-slate-900 border-t border-slate-800 hidden">
            <div class="grid grid-cols-5 gap-2">
                <div id="l1" class="status-pill bg-slate-800 text-slate-500">M1: Idle</div>
                <div id="l2" class="status-pill bg-slate-800 text-slate-500">M2: Idle</div>
                <div id="l3" class="status-pill bg-slate-800 text-slate-500">M3: Idle</div>
                <div id="l4" class="status-pill bg-slate-800 text-slate-500">M4: Idle</div>
                <div id="l5" class="status-pill bg-slate-800 text-slate-500">M5: Idle</div>
            </div>
        </div>

        <footer class="p-4 bg-slate-900 border-t border-slate-800">
            <div class="max-w-4xl mx-auto flex gap-2">
                <textarea id="promptInput" placeholder="Describe your full-stack app..." class="flex-1 bg-slate-800 border-slate-700 rounded-lg text-white p-3 h-12 outline-none focus:border-blue-500"></textarea>
                <button id="genBtn" onclick="runEnsemble()" class="bg-blue-600 px-6 rounded-lg font-bold hover:bg-blue-500 transition">DEBATE & BUILD</button>
            </div>
        </footer>
    </main>
</div>

<div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2"><span>üõ°Ô∏è</span> Ensemble Configuration</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
                <label class="text-[10px] uppercase font-bold text-slate-500">Base Endpoint & Key</label>
                <input id="apiUrl" type="text" class="w-full bg-slate-800 p-2 rounded mt-1 mb-2 border border-slate-700 text-sm" placeholder="https://openrouter.ai/api/v1/chat/completions">
                <input id="apiKey" type="password" class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-sm" placeholder="sk-...">
            </div>
            
            <div class="space-y-3">
                <label class="text-[10px] uppercase font-bold text-blue-500">Worker Models (The Debaters)</label>
                <input id="m1_id" type="text" class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-xs" placeholder="Model 1 (e.g. gpt-4o)">
                <input id="m2_id" type="text" class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-xs" placeholder="Model 2 (e.g. claude-3-sonnet)">
                <input id="m3_id" type="text" class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-xs" placeholder="Model 3 (e.g. deepseek-v3)">
                <input id="m4_id" type="text" class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-xs" placeholder="Model 4 (e.g. qwen-2.5-coder)">
                <input id="m5_id" type="text" class="w-full bg-slate-800 p-2 rounded border border-slate-700 text-xs" placeholder="Model 5 (e.g. llama-3.1-405b)">
            </div>

            <div class="space-y-3">
                <label class="text-[10px] uppercase font-bold text-purple-500">The Judge (The Finalizer)</label>
                <input id="mj_id" type="text" class="w-full bg-slate-800 p-2 rounded border border-purple-900/50 text-xs" placeholder="Judge Model (e.g. deepseek-r1)">
                <p class="text-[10px] text-slate-500 italic mt-2">The Judge reviews all 5 outputs and selects/merges the best parts into one final file.</p>
            </div>
        </div>

        <div class="mt-8 flex gap-4">
            <button onclick="saveSettings()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">Save Configuration</button>
            <button onclick="toggleSettings(false)" class="px-6 bg-slate-800 rounded-xl">Close</button>
        </div>
    </div>
</div>

<script>
    let state = {
        projects: JSON.parse(localStorage.getItem('projects') || '[]'),
        settings: JSON.parse(localStorage.getItem('ensemble_settings') || JSON.stringify({
            url: 'https://openrouter.ai/api/v1/chat/completions',
            key: '',
            models: ['','','','',''],
            judge: ''
        }))
    };

    function toggleSettings(s) { document.getElementById('settingsModal').classList.toggle('hidden', !s); }

    function saveSettings() {
        state.settings = {
            url: document.getElementById('apiUrl').value,
            key: document.getElementById('apiKey').value,
            models: [
                document.getElementById('m1_id').value,
                document.getElementById('m2_id').value,
                document.getElementById('m3_id').value,
                document.getElementById('m4_id').value,
                document.getElementById('m5_id').value
            ],
            judge: document.getElementById('mj_id').value
        };
        localStorage.setItem('ensemble_settings', JSON.stringify(state.settings));
        toggleSettings(false);
    }

    async function apiCall(prompt, modelId, logId) {
        if (!modelId) return null;
        const log = document.getElementById(logId);
        log.classList.add('text-yellow-500');
        log.innerText = "Working...";
        
        try {
            const res = await fetch(state.settings.url, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${state.settings.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    model: modelId, 
                    messages: [{role: "system", content: "Output ONLY raw code. No markdown."}, {role: "user", content: prompt}] 
                })
            });
            const raw = await res.text();
            if (!res.ok) throw new Error(raw);
            const data = JSON.parse(raw);
            log.innerText = "Finished ‚úÖ";
            log.className = "status-pill bg-green-900/20 text-green-400";
            return data.choices[0].message.content;
        } catch (e) {
            log.innerText = "Failed ‚ùå";
            log.className = "status-pill bg-red-900/20 text-red-400";
            return null;
        }
    }

    async function runEnsemble() {
        const prompt = document.getElementById('promptInput').value;
        if (!state.settings.key) return toggleSettings(true);

        document.getElementById('genBtn').disabled = true;
        document.getElementById('logTray').classList.remove('hidden');
        document.getElementById('statusText').innerText = "Status: Workers gathering code...";

        // Step 1: 5 Parallel Workers
        const tasks = state.settings.models.map((m, i) => apiCall(`Create a single-file index.html for: ${prompt}`, m, `l${i+1}`));
        const results = (await Promise.all(tasks)).filter(r => r !== null);

        // Step 2: The Judge
        document.getElementById('statusText').innerText = "Status: Judge deciding winner...";
        const judgePrompt = `I have 5 versions of a website for the prompt: "${prompt}". Pick the best parts of each or choose the single best version and return it. Output ONLY raw HTML/CSS/JS. Code:\n\n${results.join('\n---NEW VERSION---\n')}`;
        
        const finalCode = await apiCall(judgePrompt, state.settings.judge, 'statusText');
        const cleanCode = finalCode.replace(/```html|```/gi, '').trim();

        // Step 3: Render & Save
        document.getElementById('preview').srcdoc = cleanCode;
        state.projects.unshift({ id: Date.now(), title: prompt.substring(0, 30), code: cleanCode });
        localStorage.setItem('projects', JSON.stringify(state.projects));
        
        document.getElementById('genBtn').disabled = false;
        document.getElementById('statusText').innerText = "Status: Complete";
        renderHistory();
    }

    function renderHistory() {
        document.getElementById('projectList').innerHTML = state.projects.map(p => `
            <div onclick="loadProj(${p.id})" class="p-2 text-xs bg-slate-800 rounded border border-slate-700 cursor-pointer hover:bg-slate-700 truncate">${p.title}</div>
        `).join('');
    }

    function loadProj(id) {
        const p = state.projects.find(x => x.id === id);
        document.getElementById('preview').srcdoc = p.code;
    }

    function createNew() { document.getElementById('preview').srcdoc = ''; document.getElementById('promptInput').value = ''; }

    window.onload = () => {
        document.getElementById('apiUrl').value = state.settings.url;
        document.getElementById('apiKey').value = state.settings.key;
        document.getElementById('mj_id').value = state.settings.judge;
        state.settings.models.forEach((m, i) => {
            document.getElementById(`m${i+1}_id`).value = m;
        });
        renderHistory();
    };
</script>
</body>
</html>
